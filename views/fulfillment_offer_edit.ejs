<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Admin • <%= isNew ? 'Nova Oferta' : 'Editar Oferta' %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="mb-0"><%= isNew ? 'Nova Oferta' : 'Editar Oferta' %></h1>
      <div class="text-muted">Configure a oferta e as mídias (foto/vídeo) a serem enviadas após pagamento.</div>
      <% if (!isNew) { %>
        <div class="text-muted small mt-1">ID: <code><%= offer.id %></code></div>
      <% } %>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="/admin/fulfillment/offers">Voltar</a>
      <a class="btn btn-outline-secondary" href="/admin/settings">Configurações</a>
    </div>
  </div>

  <% if (ok) { %>
    <div class="alert alert-success">Salvo com sucesso.</div>
  <% } %>

  <% if (err) { %>
    <div class="alert alert-danger"><%= err %></div>
  <% } %>

  <div class="card mb-4">
    <div class="card-body">
      <form method="post" action="<%= isNew ? '/admin/fulfillment/offers/new' : ('/admin/fulfillment/offers/' + encodeURIComponent(offer.id) + '/edit') %>">
        <div class="row g-3">
          <div class="col-md-7">
            <label class="form-label">Título</label>
            <input class="form-control" name="title" value="<%= offer.title || '' %>" placeholder="Ex.: Pack 10 fotos" required />
          </div>

          <div class="col-md-3">
            <label class="form-label">Tipo</label>
            <select class="form-select" name="kind">
              <% const k = String(offer.kind || 'foto').toLowerCase(); %>
              <option value="foto" <%= (k === 'foto' || k === 'fotos') ? 'selected' : '' %>>Foto</option>
              <option value="video" <%= (k === 'video' || k === 'videos') ? 'selected' : '' %>>Vídeo</option>
            </select>
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <div class="form-check">
              <input type="hidden" name="enabled" value="0" />
              <input class="form-check-input" type="checkbox" name="enabled" value="1" id="enabled"
                <%= (offer.enabled === undefined || offer.enabled === null) ? 'checked' : (offer.enabled ? 'checked' : '') %> />
              <label class="form-check-label" for="enabled">Ativa</label>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Texto antes (opcional)</label>
            <textarea class="form-control" name="pre_text" rows="3" placeholder="Mensagem antes de enviar as mídias..."><%= offer.pre_text || '' %></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Texto depois (opcional)</label>
            <textarea class="form-control" name="post_text" rows="3" placeholder="Mensagem depois de enviar as mídias..."><%= offer.post_text || '' %></textarea>
          </div>

          <div class="col-12"><hr class="my-2" /></div>

          <div class="col-md-3">
            <label class="form-label">Delay humano min (ms)</label>
            <input class="form-control" type="number" name="delay_min_ms" value="<%= (offer.delay_min_ms ?? 30000) %>" min="0" max="600000" step="50" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Delay humano max (ms)</label>
            <input class="form-control" type="number" name="delay_max_ms" value="<%= (offer.delay_max_ms ?? 45000) %>" min="0" max="600000" step="50" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Entre mídias min (ms)</label>
            <input class="form-control" type="number" name="delay_between_min_ms" value="<%= (offer.delay_between_min_ms ?? 250) %>" min="0" max="60000" step="10" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Entre mídias max (ms)</label>
            <input class="form-control" type="number" name="delay_between_max_ms" value="<%= (offer.delay_between_max_ms ?? 900) %>" min="0" max="60000" step="10" />
          </div>

          <div class="col-12 mt-2 d-flex gap-2">
            <button class="btn btn-primary">Salvar</button>

            <% if (!isNew) { %>
              <form method="post" action="/admin/fulfillment/offers/<%= encodeURIComponent(offer.id) %>/delete" class="d-inline">
                <button class="btn btn-outline-danger"
                  onclick="return confirm('Remover esta oferta e TODAS as mídias dela?');">
                  Remover oferta
                </button>
              </form>
            <% } %>
          </div>
        </div>
      </form>
    </div>
  </div>

  <% if (!isNew) { %>
    <div class="card">
      <div class="card-body">
        <h4 class="mb-2">Mídias</h4>
        <div class="text-muted mb-3">Cadastre URLs públicas (http/https). Ordem menor aparece primeiro.</div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th style="width:110px;">Ordem</th>
                <th>URL</th>
                <th>Legenda</th>
                <th style="width:220px;"></th>
              </tr>
            </thead>
            <tbody>
              <% const list = Array.isArray(media) ? media : []; %>
              <% if (!list.length) { %>
                <tr><td colspan="4" class="text-muted">Nenhuma mídia cadastrada.</td></tr>
              <% } %>

              <% list.forEach(function(m){ %>
                <tr>
                  <td>
                    <form method="post" action="/admin/fulfillment/offers/<%= encodeURIComponent(offer.id) %>/media/<%= encodeURIComponent(m.id) %>/save">
                      <input class="form-control form-control-sm" type="number" name="sort_order" value="<%= (m.sort_order ?? 0) %>" step="1" />
                  </td>
                  <td>
                      <input class="form-control form-control-sm" name="url" value="<%= m.url || '' %>" />
                      <div class="small mt-1">
                        <a href="<%= m.url || '#' %>" target="_blank" rel="noreferrer">Abrir</a>
                      </div>
                  </td>
                  <td>
                      <input class="form-control form-control-sm" name="caption" value="<%= m.caption || '' %>" />
                  </td>
                  <td class="text-end">
                      <button class="btn btn-sm btn-outline-primary me-1">Salvar</button>
                    </form>

                    <form method="post" class="d-inline"
                      action="/admin/fulfillment/offers/<%= encodeURIComponent(offer.id) %>/media/<%= encodeURIComponent(m.id) %>/delete">
                      <button class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Remover esta mídia?');">Remover</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <hr class="my-3" />

        <h5 class="mb-2">Adicionar nova mídia</h5>
        <form method="post" action="/admin/fulfillment/offers/<%= encodeURIComponent(offer.id) %>/media/add" class="row g-2">
          <div class="col-md-2">
            <input class="form-control" type="number" name="sort_order" value="0" step="1" placeholder="Ordem" />
          </div>
          <div class="col-md-6">
            <input class="form-control" name="url" placeholder="https://..." required />
          </div>
          <div class="col-md-3">
            <input class="form-control" name="caption" placeholder="Legenda (opcional)" />
          </div>
          <div class="col-md-1 d-grid">
            <button class="btn btn-success">Adicionar</button>
          </div>
        </form>
      </div>
    </div>
  <% } %>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <title>Admin • Configurações do Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    .ai-provider-box,
    .vn-provider-box,
    .pay-gateway-box {
      display: none;
    }

    .ai-provider-box.active,
    .vn-provider-box.active,
    .pay-gateway-box.active {
      display: block;
    }
  </style>
</head>

<body class="container py-4">
  <% const s=settings || {}; %>
    <% const ap=String(s.ai_provider || 'venice' ).trim().toLowerCase(); const aiProvider=(ap==='openai' || ap==='grok'
      ) ? ap : 'venice' ; %>

      <% const pg=String(s.pix_gateway_default || 'veltrax' ).trim().toLowerCase(); %>

        <h1 class="mb-3">Configurações do Bot</h1>

        <% if (ok) { %>
          <div class="alert alert-success">Configurações salvas com sucesso.</div>
          <% } %>

            <form method="POST" action="/admin/settings" class="row g-3">

              <div class="col-12">
                <h3 class="mt-3">Configurações Globais</h3>
              </div>

              <div class="col-12">
                <label class="form-label">Graph API Access Token</label>
                <input type="text" class="form-control" name="graph_api_access_token"
                  value="<%= (s.graph_api_access_token || '') %>" placeholder="EAAB...">
                <div class="form-text">Token usado para chamadas na Graph API (se aplicável). Os números Meta podem ter
                  token próprio.</div>
              </div>

              <div class="col-12">
                <label class="form-label">Verify Token (Webhook)</label>
                <input type="text" class="form-control" name="contact_token" value="<%= (s.contact_token || '') %>"
                  placeholder="qualquer string (igual ao configurado no Meta)">
                <div class="form-text">Esse valor precisa bater com o <code>hub.verify_token</code> configurado no
                  Webhook da Meta.</div>
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Meta • Marketing API (Campanhas)</h3>
                <div class="form-text">
                  Usado para resolver <b>Campanha / Conjunto / Anúncio</b> a partir do <code>referral.source_id</code>
                  (CTWA).
                  Se este token estiver vazio, o backend usa o <b>Graph API Access Token</b> global como fallback.
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Meta Ads Access Token</label>
                <input type="text" class="form-control" name="meta_ads_access_token"
                  value="<%= (s.meta_ads_access_token || '') %>" placeholder="EAAB...">
                <div class="form-text">
                  Precisa ter permissão <code>ads_read</code> (ou superior) e acesso à conta de anúncios.
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Ad Account ID (opcional)</label>
                <input type="text" class="form-control" name="meta_ads_ad_account_id"
                  value="<%= (s.meta_ads_ad_account_id || '') %>" placeholder="act_123...">
                <div class="form-text">Opcional (fica pronto pra insights depois).</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Graph API Version</label>
                <input type="text" class="form-control" name="meta_ads_api_version"
                  value="<%= (s.meta_ads_api_version !== undefined && s.meta_ads_api_version !== null) ? s.meta_ads_api_version : 'v20.0' %>"
                  placeholder="v20.0">
              </div>

              <div class="col-md-4">
                <label class="form-label">Timeout (ms)</label>
                <input type="number" class="form-control" name="meta_ads_timeout_ms"
                  value="<%= (s.meta_ads_timeout_ms !== undefined && s.meta_ads_timeout_ms !== null) ? s.meta_ads_timeout_ms : 15000 %>"
                  min="1000" max="120000" step="500">
              </div>

              <div class="col-md-4">
                <label class="form-label">Cache TTL (ms)</label>
                <input type="number" class="form-control" name="meta_ads_cache_ttl_ms"
                  value="<%= (s.meta_ads_cache_ttl_ms !== undefined && s.meta_ads_cache_ttl_ms !== null) ? s.meta_ads_cache_ttl_ms : 3600000 %>"
                  min="0" max="604800000" step="1000">
                <div class="form-text">Cache em memória (0 desativa).</div>
              </div>

              <hr class="my-3" />

              <!-- =========================
      PAGAMENTOS • MULTI-GATEWAY
      - Dropdown escolhe gateway padrão
      - Só mostra a box do gateway selecionado
      ========================= -->
              <div class="col-12">
                <h3 class="mt-3">Pagamentos • PIX (Multi-Gateway)</h3>
                <div class="form-text">Escolha o gateway padrão. Você também pode forçar via ctx.vars.pix_gateway.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Gateway padrão</label>
                <select class="form-select" name="pix_gateway_default" id="pix_gateway_default">
                  <option value="veltrax" <%=(pg==='veltrax' ? 'selected' : '' ) %>>Veltrax</option>
                  <option value="rapdyn" <%=(pg==='rapdyn' ? 'selected' : '' ) %>>Rapdyn</option>
                  <option value="zoompag" <%=(pg==='zoompag' ? 'selected' : '' ) %>>Zoompag</option>
                </select>
                <div class="form-text">O painel salva configs de todos os gateways, mas exibe só o selecionado.</div>
              </div>

              <!-- VELTRAX BOX -->
              <div class="col-12 pay-gateway-box" id="pay_gateway_veltrax">
                <div class="card border-0 bg-light mt-2">
                  <div class="card-body">
                    <h5 class="mb-2">Configurações • Veltrax</h5>
                    <div class="form-text mb-3">Tudo salvo no DB (sem env var). Usado para gerar PIX via API e receber
                      webhook.</div>

                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label">Veltrax API Base URL</label>
                        <input type="text" class="form-control" name="veltrax_api_base_url"
                          value="<%= (s.veltrax_api_base_url !== undefined && s.veltrax_api_base_url !== null) ? s.veltrax_api_base_url : 'https://api.veltraxpay.com' %>">
                        <div class="form-text">Normalmente: https://api.veltraxpay.com</div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Veltrax client_id</label>
                        <input type="text" class="form-control" name="veltrax_client_id"
                          value="<%= (s.veltrax_client_id || '') %>" placeholder="seu_client_id">
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Veltrax client_secret</label>
                        <input type="text" class="form-control" name="veltrax_client_secret"
                          value="<%= (s.veltrax_client_secret || '') %>" placeholder="seu_client_secret">
                      </div>

                      <div class="col-md-8">
                        <label class="form-label">Callback Base URL (domínio público do seu server)</label>
                        <input type="text" class="form-control" name="veltrax_callback_base_url"
                          value="<%= (s.veltrax_callback_base_url || '') %>" placeholder="https://seu-dominio.com">
                        <div class="form-text">Usado para montar o clientCallbackUrl do depósito.</div>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label">Webhook Path</label>
                        <input type="text" class="form-control" name="veltrax_webhook_path"
                          value="<%= (s.veltrax_webhook_path !== undefined && s.veltrax_webhook_path !== null) ? s.veltrax_webhook_path : '/webhook/veltrax' %>">
                        <div class="form-text">Ex.: /webhook/veltrax</div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>

              <!-- RAPDYN BOX -->
              <div class="col-12 pay-gateway-box" id="pay_gateway_rapdyn">
                <div class="card border-0 bg-light mt-2">
                  <div class="card-body">
                    <h5 class="mb-2">Configurações • Rapdyn</h5>
                    <div class="form-text mb-3">Config do gateway Rapdyn (base URL, token, path do create e webhook).
                    </div>

                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label">Rapdyn API Base URL</label>
                        <input type="text" class="form-control" name="rapdyn_api_base_url"
                          value="<%= (s.rapdyn_api_base_url !== undefined && s.rapdyn_api_base_url !== null) ? s.rapdyn_api_base_url : 'https://app.rapdyn.io/api' %>"
                          placeholder="https://app.rapdyn.io/api">
                        <div class="form-text">Conforme doc: <code>https://app.rapdyn.io/api</code></div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Rapdyn Token (Bearer)</label>
                        <input type="text" class="form-control" name="rapdyn_api_key"
                          value="<%= (s.rapdyn_api_key || '') %>" placeholder="token gerado na plataforma">
                        <div class="form-text">Enviado como <code>Authorization: Bearer &lt;TOKEN&gt;</code>.</div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Rapdyn API Secret (se existir / legado)</label>
                        <input type="text" class="form-control" name="rapdyn_api_secret"
                          value="<%= (s.rapdyn_api_secret || '') %>">
                        <div class="form-text">Opcional. Se seu backend estiver usando apenas Bearer, pode ficar vazio.
                        </div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Rapdyn Create Path</label>
                        <input type="text" class="form-control" name="rapdyn_create_path"
                          value="<%= (s.rapdyn_create_path !== undefined && s.rapdyn_create_path !== null) ? s.rapdyn_create_path : '/payments' %>"
                          placeholder="/payments">
                        <div class="form-text">Conforme doc: <code>/payments</code></div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Callback Base URL (domínio público do seu server)</label>
                        <input type="text" class="form-control" name="rapdyn_callback_base_url"
                          value="<%= (s.rapdyn_callback_base_url || '') %>" placeholder="https://seu-dominio.com">
                        <div class="form-text">Só necessário se você usar webhook/callback próprio no seu fluxo.</div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Webhook Path</label>
                        <input type="text" class="form-control" name="rapdyn_webhook_path"
                          value="<%= (s.rapdyn_webhook_path || '/webhook/rapdyn') %>">
                        <div class="form-text">Ex.: /webhook/rapdyn</div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>

              <!-- ZOOMPAG BOX -->
              <div class="col-12 pay-gateway-box" id="pay_gateway_zoompag">
                <div class="card border-0 bg-light mt-2">
                  <div class="card-body">
                    <h5 class="mb-2">Configurações • Zoompag</h5>
                    <div class="form-text mb-3">Config do gateway Zoompag (base URL, API key, path do create e webhook).
                    </div>
                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label">Zoompag API Base URL</label>
                        <input type="text" class="form-control" name="zoompag_api_base_url"
                          value="<%= (s.zoompag_api_base_url !== undefined && s.zoompag_api_base_url !== null) ? s.zoompag_api_base_url : 'https://api.zoompag.com' %>">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Zoompag API Key (x-api-key)</label>
                        <input type="text" class="form-control" name="zoompag_api_key"
                          value="<%= (s.zoompag_api_key || '') %>">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Zoompag Create Path</label>
                        <input type="text" class="form-control" name="zoompag_create_path"
                          value="<%= (s.zoompag_create_path !== undefined && s.zoompag_create_path !== null) ? s.zoompag_create_path : '/transactions' %>">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Callback Base URL</label>
                        <input type="text" class="form-control" name="zoompag_callback_base_url"
                          value="<%= (s.zoompag_callback_base_url || '') %>">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Webhook Path</label>
                        <input type="text" class="form-control" name="zoompag_webhook_path"
                          value="<%= (s.zoompag_webhook_path !== undefined && s.zoompag_webhook_path !== null) ? s.zoompag_webhook_path : '/webhook/zoompag' %>">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Utmify</h3>
              </div>

              <div class="col-12">
                <label class="form-label">Utmify API Token</label>
                <input type="text" class="form-control" name="utmify_api_token"
                  value="<%= (s.utmify_api_token || '') %>" placeholder="ex.: KVRxalfMiBfm8Rm1nP5YxfwYzArNsA0VLeWC">
                <div class="form-text">Credencial de API para enviar vendas pendentes e aprovadas.</div>
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Logs</h3>
              </div>

              <div class="col-12">
                <div class="form-check">
                  <input type="hidden" name="ai_debug" value="0" />
                  <input class="form-check-input" type="checkbox" name="ai_debug" value="1" id="ai_debug"
                    <%=((s.ai_debug===undefined || s.ai_debug===null) ? true : !!s.ai_debug) ? 'checked' : '' %> />
                  <label class="form-check-label" for="ai_debug">
                    AI Debug (liga/desliga logs do aiLog sem restart)
                  </label>
                </div>
              </div>

              <hr class="my-3" />

              <!-- =========================
      IA PROVIDER (VENICE/OPENAI)
      - Mesma seção
      - Só mostra o provider selecionado
      ========================= -->
              <div class="col-12">
                <h3 class="mt-3">IA • Provider</h3>
                <div class="form-text">Escolha o provider e edite as configs no mesmo lugar. O painel só exibe o
                  provider selecionado.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Provider</label>
                <select class="form-select" name="ai_provider" id="ai_provider">
                  <option value="venice" <%=(aiProvider==='venice' ) ? 'selected' : '' %>>Venice</option>
                  <option value="openai" <%=(aiProvider==='openai' ) ? 'selected' : '' %>>OpenAI</option>
                  <option value="grok" <%=(aiProvider==='grok' ) ? 'selected' : '' %>>Grok</option>
                </select>
                <div class="form-text">Dica: as configs do outro provider ficam salvas no DB mesmo quando não aparecem.
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Max msgs por resposta (AI)</label>
                <input type="number" class="form-control" name="ai_max_out_messages"
                  value="<%= (s.ai_max_out_messages !== undefined && s.ai_max_out_messages !== null) ? s.ai_max_out_messages : 3 %>"
                  min="1" max="10" step="1">
              </div>

              <div class="col-md-4">
                <label class="form-label">AI Timeout (ms)</label>
                <input type="number" class="form-control" name="venice_timeout_ms"
                  value="<%= (s.venice_timeout_ms !== undefined && s.venice_timeout_ms !== null) ? s.venice_timeout_ms : 60000 %>"
                  min="1000" max="180000" step="500">
                <div class="form-text">Campo compartilhado pros dois providers (reaproveitando o mesmo setting).</div>
              </div>

              <div class="col-12">
                <label class="form-label">System Prompt</label>
                <textarea class="form-control" name="system_prompt" rows="10"
                  placeholder="Cole aqui o prompt do agente..."><%- (s.system_prompt || '' ) %></textarea>
                <div class="form-text">Prompt é comum aos providers (o modelo precisa responder em JSON conforme seu
                  contrato).</div>
              </div>

              <div class="col-12">
                <label class="form-label">Mensagem fixa do usuário (AI)</label>
                <input type="text" class="form-control" name="venice_user_message"
                  value="<%= (s.venice_user_message !== undefined && s.venice_user_message !== null) ? s.venice_user_message : 'Responda exatamente no formato JSON especificado.' %>">
                <div class="form-text">Campo compartilhado pros dois providers (reaproveitando o mesmo setting).</div>
              </div>

              <!-- VENICE BOX -->
              <div class="col-12 ai-provider-box" id="ai_provider_venice">
                <div class="card border-0 bg-light mt-2">
                  <div class="card-body">
                    <h5 class="mb-3">Configurações • Venice</h5>

                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label">Venice API Key</label>
                        <input type="text" class="form-control" name="venice_api_key"
                          value="<%= (s.venice_api_key || '') %>" placeholder="vnc_...">
                      </div>

                      <div class="col-12">
                        <label class="form-label">Venice Model</label>
                        <input type="text" class="form-control" name="venice_model"
                          value="<%= (s.venice_model || '') %>" placeholder="ex.: llama-3.1-...">
                      </div>

                      <div class="col-12">
                        <label class="form-label">Venice API URL (completions)</label>
                        <input type="text" class="form-control" name="venice_api_url"
                          value="<%= (s.venice_api_url !== undefined && s.venice_api_url !== null) ? s.venice_api_url : 'https://api.venice.ai/api/v1/chat/completions' %>">
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Temperature</label>
                        <input type="number" class="form-control" name="venice_temperature"
                          value="<%= (s.venice_temperature !== undefined && s.venice_temperature !== null) ? s.venice_temperature : 0.7 %>"
                          min="0" max="2" step="0.1">
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Max Tokens</label>
                        <input type="number" class="form-control" name="venice_max_tokens"
                          value="<%= (s.venice_max_tokens !== undefined && s.venice_max_tokens !== null) ? s.venice_max_tokens : 700 %>"
                          min="16" max="4096" step="1">
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">enable_web_search</label>
                        <input type="text" class="form-control" name="venice_enable_web_search"
                          value="<%= (s.venice_enable_web_search !== undefined && s.venice_enable_web_search !== null) ? s.venice_enable_web_search : 'off' %>">
                        <div class="form-text">Ex.: off / on (depende do Venice)</div>
                      </div>

                      <div class="col-12">
                        <div class="row g-2 mt-1">
                          <div class="col-md-4">
                            <div class="form-check">
                              <input type="hidden" name="venice_include_venice_system_prompt" value="0" />
                              <input class="form-check-input" type="checkbox" name="venice_include_venice_system_prompt"
                                value="1" id="venice_include_venice_system_prompt"
                                <%=((s.venice_include_venice_system_prompt===undefined ||
                                s.venice_include_venice_system_prompt===null) ? false :
                                !!s.venice_include_venice_system_prompt) ? 'checked' : '' %> />
                              <label class="form-check-label"
                                for="venice_include_venice_system_prompt">include_venice_system_prompt</label>
                            </div>
                          </div>
                          <div class="col-md-4">
                            <div class="form-check">
                              <input type="hidden" name="venice_enable_web_citations" value="0" />
                              <input class="form-check-input" type="checkbox" name="venice_enable_web_citations"
                                value="1" id="venice_enable_web_citations"
                                <%=((s.venice_enable_web_citations===undefined || s.venice_enable_web_citations===null)
                                ? false : !!s.venice_enable_web_citations) ? 'checked' : '' %> />
                              <label class="form-check-label"
                                for="venice_enable_web_citations">enable_web_citations</label>
                            </div>
                          </div>
                          <div class="col-md-4">
                            <div class="form-check">
                              <input type="hidden" name="venice_enable_web_scraping" value="0" />
                              <input class="form-check-input" type="checkbox" name="venice_enable_web_scraping"
                                value="1" id="venice_enable_web_scraping" <%=((s.venice_enable_web_scraping===undefined
                                || s.venice_enable_web_scraping===null) ? false : !!s.venice_enable_web_scraping)
                                ? 'checked' : '' %> />
                              <label class="form-check-label"
                                for="venice_enable_web_scraping">enable_web_scraping</label>
                            </div>
                          </div>
                        </div>

                        <div class="form-check mt-2">
                          <input type="hidden" name="venice_stream" value="0" />
                          <input class="form-check-input" type="checkbox" name="venice_stream" value="1"
                            id="venice_stream" <%=((s.venice_stream===undefined || s.venice_stream===null) ? false :
                            !!s.venice_stream) ? 'checked' : '' %> />
                          <label class="form-check-label" for="venice_stream">stream</label>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>

              <!-- OPENAI BOX -->
              <div class="col-12 ai-provider-box" id="ai_provider_openai">
                <div class="card border-0 bg-light mt-2">
                  <div class="card-body">
                    <h5 class="mb-3">Configurações • OpenAI</h5>

                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label">OpenAI API Key</label>
                        <input type="text" class="form-control" name="openai_api_key"
                          value="<%= (s.openai_api_key || '') %>" placeholder="sk-...">
                      </div>

                      <div class="col-12">
                        <label class="form-label">OpenAI Model</label>
                        <input type="text" class="form-control" name="openai_model"
                          value="<%= (s.openai_model || '') %>" placeholder="ex.: gpt-4.1-mini / gpt-4.1 / etc">
                      </div>

                      <div class="col-12">
                        <label class="form-label">OpenAI API URL (Responses)</label>
                        <input type="text" class="form-control" name="openai_api_url"
                          value="<%= (s.openai_api_url !== undefined && s.openai_api_url !== null) ? s.openai_api_url : 'https://api.openai.com/v1/responses' %>">
                        <div class="form-text">Default: https://api.openai.com/v1/responses</div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Max Output Tokens</label>
                        <input type="number" class="form-control" name="openai_max_output_tokens"
                          value="<%= (s.openai_max_output_tokens !== undefined && s.openai_max_output_tokens !== null) ? s.openai_max_output_tokens : '' %>"
                          min="16" max="32768" step="1" placeholder="(opcional)">
                        <div class="form-text">Se vazio, o backend usa o default do seu cfg (ou o do modelo).</div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Reasoning Effort</label>
                        <select class="form-select" name="openai_reasoning_effort">
                          <% const re=String(s.openai_reasoning_effort || '' ).trim().toLowerCase(); %>
                            <option value="" <%=(!re ? 'selected' : '' ) %>>(padrão)</option>
                            <option value="low" <%=(re==='low' ? 'selected' : '' ) %>>low</option>
                            <option value="medium" <%=(re==='medium' ? 'selected' : '' ) %>>medium</option>
                            <option value="high" <%=(re==='high' ? 'selected' : '' ) %>>high</option>
                        </select>
                        <div class="form-text">Ajusta o “esforço” do modelo (se suportado pelo modelo escolhido).</div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>

              <!-- GROK BOX -->
              <div class="col-12 ai-provider-box" id="ai_provider_grok">
                <div class="card border-0 bg-light mt-2">
                  <div class="card-body">
                    <h5 class="mb-3">Configurações • Grok</h5>

                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label">Grok API Key</label>
                        <input type="text" class="form-control" name="grok_api_key"
                          value="<%= (s.grok_api_key || '') %>" placeholder="xai_...">
                      </div>

                      <div class="col-12">
                        <label class="form-label">Grok Model</label>
                        <input type="text" class="form-control" name="grok_model" value="<%= (s.grok_model || '') %>"
                          placeholder="ex.: grok-...">
                      </div>

                      <div class="col-12">
                        <label class="form-label">Grok API URL (chat completions)</label>
                        <input type="text" class="form-control" name="grok_api_url"
                          value="<%= (s.grok_api_url !== undefined && s.grok_api_url !== null) ? s.grok_api_url : 'https://api.x.ai/v1/chat/completions' %>">
                        <div class="form-text">Default sugerido: https://api.x.ai/v1/chat/completions</div>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Temperature</label>
                        <input type="number" class="form-control" name="grok_temperature"
                          value="<%= (s.grok_temperature !== undefined && s.grok_temperature !== null) ? s.grok_temperature : 0.7 %>"
                          min="0" max="2" step="0.1">
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Max Tokens</label>
                        <input type="number" class="form-control" name="grok_max_tokens"
                          value="<%= (s.grok_max_tokens !== undefined && s.grok_max_tokens !== null) ? s.grok_max_tokens : 700 %>"
                          min="16" max="4096" step="1">
                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Voice Note Grok Model (opcional)</label>
                        <input type="text" class="form-control" name="voice_note_grok_model"
                          value="<%= (s.voice_note_grok_model || '') %>" placeholder="(se vazio, usa grok_model)">
                      </div>
                    </div>

                  </div>
                </div>
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Áudio (TTS) • ElevenLabs</h3>
                <div class="form-text">Configs do envio de áudio. Sem fallback em <code>process.env</code>.</div>
              </div>

              <div class="col-12">
                <label class="form-label">ElevenLabs API Key</label>
                <input type="text" class="form-control" name="elevenlabs_api_key"
                  value="<%= (s.elevenlabs_api_key || '') %>" placeholder="xi_...">
              </div>

              <div class="col-md-6">
                <label class="form-label">Voice ID</label>
                <input type="text" class="form-control" name="eleven_voice_id" value="<%= (s.eleven_voice_id || '') %>"
                  placeholder="ex.: 21m00Tcm4TlvDq8ikWAM">
              </div>

              <div class="col-md-3">
                <label class="form-label">Model ID</label>
                <input type="text" class="form-control" name="eleven_model_id"
                  value="<%= (s.eleven_model_id !== undefined && s.eleven_model_id !== null) ? s.eleven_model_id : 'eleven_v3' %>"
                  placeholder="eleven_v3">
              </div>

              <div class="col-md-3">
                <label class="form-label">Output Format</label>
                <input type="text" class="form-control" name="eleven_output_format"
                  value="<%= (s.eleven_output_format !== undefined && s.eleven_output_format !== null) ? s.eleven_output_format : 'ogg_opus' %>"
                  placeholder="ogg_opus">
              </div>

              <div class="col-md-3">
                <label class="form-label">stability (0–1)</label>
                <input type="number" class="form-control" name="eleven_stability"
                  value="<%= (s.eleven_stability !== undefined && s.eleven_stability !== null) ? s.eleven_stability : '' %>"
                  min="0" max="1" step="0.01" placeholder="(opcional)">
              </div>

              <div class="col-md-3">
                <label class="form-label">similarity_boost (0–1)</label>
                <input type="number" class="form-control" name="eleven_similarity_boost"
                  value="<%= (s.eleven_similarity_boost !== undefined && s.eleven_similarity_boost !== null) ? s.eleven_similarity_boost : '' %>"
                  min="0" max="1" step="0.01" placeholder="(opcional)">
              </div>

              <div class="col-md-3">
                <label class="form-label">style (0–1)</label>
                <input type="number" class="form-control" name="eleven_style"
                  value="<%= (s.eleven_style !== undefined && s.eleven_style !== null) ? s.eleven_style : '' %>" min="0"
                  max="1" step="0.01" placeholder="(opcional)">
              </div>

              <div class="col-md-3 d-flex align-items-end">
                <div class="form-check">
                  <input type="hidden" name="eleven_use_speaker_boost" value="0" />
                  <input class="form-check-input" type="checkbox" name="eleven_use_speaker_boost" value="1"
                    id="eleven_use_speaker_boost" <%=((s.eleven_use_speaker_boost===undefined ||
                    s.eleven_use_speaker_boost===null) ? false : !!s.eleven_use_speaker_boost) ? 'checked' : '' %> />
                  <label class="form-check-label" for="eleven_use_speaker_boost">use_speaker_boost</label>
                </div>
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Debounce</h3>
              </div>

              <div class="col-md-4">
                <label class="form-label">Debounce Min (ms)</label>
                <input type="number" class="form-control" name="inbound_debounce_min_ms"
                  value="<%= (s.inbound_debounce_min_ms !== undefined && s.inbound_debounce_min_ms !== null) ? s.inbound_debounce_min_ms : 1800 %>"
                  min="200" max="15000" step="50">
              </div>

              <div class="col-md-4">
                <label class="form-label">Debounce Max (ms)</label>
                <input type="number" class="form-control" name="inbound_debounce_max_ms"
                  value="<%= (s.inbound_debounce_max_ms !== undefined && s.inbound_debounce_max_ms !== null) ? s.inbound_debounce_max_ms : 3200 %>"
                  min="200" max="20000" step="50">
              </div>

              <div class="col-md-4">
                <label class="form-label">Max Wait (ms)</label>
                <input type="number" class="form-control" name="inbound_max_wait_ms"
                  value="<%= (s.inbound_max_wait_ms !== undefined && s.inbound_max_wait_ms !== null) ? s.inbound_max_wait_ms : 12000 %>"
                  min="500" max="60000" step="100">
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Lead Store</h3>
              </div>

              <div class="col-md-3">
                <label class="form-label">MaxMsgs (histórico por lead)</label>
                <input type="number" class="form-control" name="lead_max_msgs"
                  value="<%= (s.lead_max_msgs !== undefined && s.lead_max_msgs !== null) ? s.lead_max_msgs : 50 %>"
                  min="5" max="500" step="1">
              </div>

              <div class="col-md-3">
                <label class="form-label">TTL (ms)</label>
                <input type="number" class="form-control" name="lead_ttl_ms"
                  value="<%= (s.lead_ttl_ms !== undefined && s.lead_ttl_ms !== null) ? s.lead_ttl_ms : 604800000 %>"
                  min="60000" max="2147000000" step="1000">
                <div class="form-text">Default: 7 dias = 604800000</div>
              </div>

              <div class="col-md-3">
                <label class="form-label">Late-Join Window (ms)</label>
                <input type="number" class="form-control" name="lead_late_join_window_ms"
                  value="<%= (s.lead_late_join_window_ms !== undefined && s.lead_late_join_window_ms !== null) ? s.lead_late_join_window_ms : 350 %>"
                  min="0" max="5000" step="10">
              </div>

              <div class="col-md-3">
                <label class="form-label">Preview/log max len</label>
                <input type="number" class="form-control" name="lead_preview_text_max_len"
                  value="<%= (s.lead_preview_text_max_len !== undefined && s.lead_preview_text_max_len !== null) ? s.lead_preview_text_max_len : 80 %>"
                  min="10" max="500" step="1">
              </div>

              <div class="col-12">
                <div class="form-check">
                  <input type="hidden" name="lead_debug_debounce" value="0" />
                  <input class="form-check-input" type="checkbox" name="lead_debug_debounce" value="1"
                    id="lead_debug_debounce" <%=((s.lead_debug_debounce===undefined || s.lead_debug_debounce===null) ?
                    true : !!s.lead_debug_debounce) ? 'checked' : '' %> />
                  <label class="form-check-label" for="lead_debug_debounce">
                    Debug Debounce (logs do lead.js)
                  </label>
                </div>
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Áudio Automático</h3>
              </div>

              <div class="col-12">
                <div class="form-check">
                  <input type="hidden" name="auto_audio_enabled" value="0" />
                  <input class="form-check-input" type="checkbox" name="auto_audio_enabled" value="1"
                    id="auto_audio_enabled" <%=((s.auto_audio_enabled===undefined || s.auto_audio_enabled===null) ?
                    false : !!s.auto_audio_enabled) ? 'checked' : '' %> />
                  <label class="form-check-label" for="auto_audio_enabled">
                    Ativar áudio automático
                  </label>
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Quantidade de mensagens</label>
                <input type="number" class="form-control" name="auto_audio_after_msgs"
                  value="<%= (s.auto_audio_after_msgs !== undefined && s.auto_audio_after_msgs !== null) ? s.auto_audio_after_msgs : 12 %>"
                  min="15" max="1000" step="1">
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Voice Note (enviar_audio.js) • Geração do script</h3>
                <% const vnProvRaw=String(s.voice_note_ai_provider || 'inherit' ).trim().toLowerCase(); const
                  vnProv=(vnProvRaw==='openai' || vnProvRaw==='venice' ) ? vnProvRaw : 'inherit' ; %>

                  <div class="col-md-4">
                    <label class="form-label">VoiceNote Provider (script)</label>
                    <select class="form-select" name="voice_note_ai_provider" id="voice_note_ai_provider">
                      <option value="inherit" <%=(vnProv==='inherit' ) ? 'selected' : '' %>>
                        Herdar do Provider global
                      </option>
                      <option value="venice" <%=(vnProv==='venice' ) ? 'selected' : '' %>>Venice</option>
                      <option value="openai" <%=(vnProv==='openai' ) ? 'selected' : '' %>>OpenAI</option>
                    </select>
                    <div class="form-text">
                      Controla apenas a geração do roteiro do áudio (antes do ElevenLabs). Se “Herdar”, usa o provider
                      global.
                    </div>
                  </div>

                  <div class="col-md-8 vn-provider-box" id="vn_provider_venice">
                    <label class="form-label">VoiceNote • Venice Model (opcional)</label>
                    <input type="text" class="form-control" name="voice_note_venice_model"
                      value="<%= (s.voice_note_venice_model || '') %>" placeholder="ex.: llama-3.1-...">
                    <div class="form-text">Se vazio, usa o <b>Venice Model</b> global.</div>
                  </div>

                  <div class="col-md-8 vn-provider-box" id="vn_provider_openai">
                    <label class="form-label">VoiceNote • OpenAI Model (opcional)</label>
                    <input type="text" class="form-control" name="voice_note_openai_model"
                      value="<%= (s.voice_note_openai_model || '') %>" placeholder="ex.: gpt-4.1-mini / gpt-4.1 / etc">
                    <div class="form-text">Se vazio, usa o <b>OpenAI Model</b> global.</div>
                  </div>

                  <div class="form-text">Essas configs controlam o prompt e parâmetros usados só para gerar o texto do
                    áudio.</div>
              </div>

              <div class="col-md-3">
                <label class="form-label">VoiceNote Temperature</label>
                <input type="number" class="form-control" name="voice_note_temperature"
                  value="<%= (s.voice_note_temperature !== undefined && s.voice_note_temperature !== null) ? s.voice_note_temperature : 0.85 %>"
                  min="0" max="2" step="0.05">
              </div>

              <div class="col-md-3">
                <label class="form-label">VoiceNote Max Tokens</label>
                <input type="number" class="form-control" name="voice_note_max_tokens"
                  value="<%= (s.voice_note_max_tokens !== undefined && s.voice_note_max_tokens !== null) ? s.voice_note_max_tokens : 220 %>"
                  min="16" max="4096" step="1">
              </div>

              <div class="col-md-3">
                <label class="form-label">VoiceNote Timeout (ms)</label>
                <input type="number" class="form-control" name="voice_note_timeout_ms"
                  value="<%= (s.voice_note_timeout_ms !== undefined && s.voice_note_timeout_ms !== null) ? s.voice_note_timeout_ms : 45000 %>"
                  min="1000" max="180000" step="500">
              </div>

              <div class="col-md-3">
                <label class="form-label">Hist Max Items</label>
                <input type="number" class="form-control" name="voice_note_history_max_items"
                  value="<%= (s.voice_note_history_max_items !== undefined && s.voice_note_history_max_items !== null) ? s.voice_note_history_max_items : 10 %>"
                  min="1" max="50" step="1">
              </div>

              <div class="col-md-4">
                <label class="form-label">Hist Max Chars</label>
                <input type="number" class="form-control" name="voice_note_history_max_chars"
                  value="<%= (s.voice_note_history_max_chars !== undefined && s.voice_note_history_max_chars !== null) ? s.voice_note_history_max_chars : 1600 %>"
                  min="200" max="8000" step="50">
              </div>

              <div class="col-md-4">
                <label class="form-label">Script Max Chars (hard cut)</label>
                <input type="number" class="form-control" name="voice_note_script_max_chars"
                  value="<%= (s.voice_note_script_max_chars !== undefined && s.voice_note_script_max_chars !== null) ? s.voice_note_script_max_chars : 650 %>"
                  min="200" max="4000" step="50">
              </div>

              <div class="col-md-4">
                <label class="form-label">Fallback Text (se Venice falhar)</label>
                <input type="text" class="form-control" name="voice_note_fallback_text"
                  value="<%= (s.voice_note_fallback_text || '') %>">
              </div>

              <div class="col-12">
                <label class="form-label">VoiceNote • System Prompt</label>
                <textarea class="form-control" name="voice_note_system_prompt" rows="10"
                  placeholder="Prompt do roteiro de áudio..."><%- (s.voice_note_system_prompt || '' ) %></textarea>
              </div>

              <div class="col-12">
                <label class="form-label">VoiceNote • User Prompt Template</label>
                <div class="form-text">Use <code>{{CHAT}}</code> para inserir o histórico.</div>
                <textarea class="form-control" name="voice_note_user_prompt" rows="6"
                  placeholder="Template do user prompt..."><%- (s.voice_note_user_prompt || '' ) %></textarea>
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Transcrição (STT) • Áudio recebido</h3>
                <div class="form-text">
                  Essas configs controlam a transcrição de áudios recebidos (voice notes) antes de entrarem no seu fluxo
                  de IA.
                  Tudo salvo no DB e aplicado sem restart.
                </div>
              </div>

              <div class="col-12">
                <div class="form-check">
                  <input type="hidden" name="openai_transcribe_enabled" value="0" />
                  <input class="form-check-input" type="checkbox" name="openai_transcribe_enabled" value="1"
                    id="openai_transcribe_enabled" <%=((s.openai_transcribe_enabled===undefined ||
                    s.openai_transcribe_enabled===null) ? true : !!s.openai_transcribe_enabled) ? 'checked' : '' %> />
                  <label class="form-check-label" for="openai_transcribe_enabled">
                    Ativar transcrição de áudio
                  </label>
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">STT Model</label>
                <input type="text" class="form-control" name="openai_transcribe_model"
                  value="<%= (s.openai_transcribe_model !== undefined && s.openai_transcribe_model !== null) ? s.openai_transcribe_model : 'whisper-1' %>"
                  placeholder="whisper-1">
                <div class="form-text">Se vazio, cai no default (whisper-1).</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Language</label>
                <input type="text" class="form-control" name="openai_transcribe_language"
                  value="<%= (s.openai_transcribe_language !== undefined && s.openai_transcribe_language !== null) ? s.openai_transcribe_language : 'pt' %>"
                  placeholder="pt">
                <div class="form-text">Use <code>pt</code> ou deixe vazio para autodetect.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">STT Timeout (ms)</label>
                <input type="number" class="form-control" name="openai_transcribe_timeout_ms"
                  value="<%= (s.openai_transcribe_timeout_ms !== undefined && s.openai_transcribe_timeout_ms !== null) ? s.openai_transcribe_timeout_ms : 60000 %>"
                  min="1000" max="300000" step="500">
              </div>

              <div class="col-12">
                <label class="form-label">STT Prompt (opcional)</label>
                <input type="text" class="form-control" name="openai_transcribe_prompt"
                  value="<%= (s.openai_transcribe_prompt !== undefined && s.openai_transcribe_prompt !== null) ? s.openai_transcribe_prompt : '' %>"
                  placeholder="(opcional) contexto pra melhorar a transcrição...">
                <div class="form-text">Se vazio, não envia prompt no endpoint de transcrição.</div>
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Mensagens fixas (AI)</h3>
              </div>

              <div class="col-12">
                <label class="form-label">Msg: config incompleta</label>
                <input type="text" class="form-control" name="ai_error_msg_config"
                  value="<%= (s.ai_error_msg_config !== undefined && s.ai_error_msg_config !== null) ? s.ai_error_msg_config : 'Config incompleta no painel (venice key/model/prompt).' %>">
              </div>

              <div class="col-12">
                <label class="form-label">Msg: erro genérico</label>
                <input type="text" class="form-control" name="ai_error_msg_generic"
                  value="<%= (s.ai_error_msg_generic !== undefined && s.ai_error_msg_generic !== null) ? s.ai_error_msg_generic : 'Tive um erro aqui. Manda de novo?' %>">
              </div>

              <div class="col-12">
                <label class="form-label">Msg: parse inválido</label>
                <input type="text" class="form-control" name="ai_error_msg_parse"
                  value="<%= (s.ai_error_msg_parse !== undefined && s.ai_error_msg_parse !== null) ? s.ai_error_msg_parse : 'Não entendi direito. Me manda de novo?' %>">
              </div>

              <hr class="my-3" />

              <div class="col-12">
                <h3 class="mt-3">Human Delays (AI)</h3>
                <div class="form-text">Esses valores replicam exatamente os hardcoded atuais, só que editáveis no DB.
                </div>
              </div>

              <div class="col-12">
                <h5 class="mt-2">Inbound</h5>
              </div>

              <div class="col-md-3"><label class="form-label">Base Min</label>
                <input type="number" class="form-control" name="ai_in_delay_base_min_ms"
                  value="<%= (s.ai_in_delay_base_min_ms !== undefined && s.ai_in_delay_base_min_ms !== null) ? s.ai_in_delay_base_min_ms : 900 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Base Max</label>
                <input type="number" class="form-control" name="ai_in_delay_base_max_ms"
                  value="<%= (s.ai_in_delay_base_max_ms !== undefined && s.ai_in_delay_base_max_ms !== null) ? s.ai_in_delay_base_max_ms : 1800 %>">
              </div>
              <div class="col-md-3"><label class="form-label">PerChar Min</label>
                <input type="number" class="form-control" name="ai_in_delay_per_char_min_ms"
                  value="<%= (s.ai_in_delay_per_char_min_ms !== undefined && s.ai_in_delay_per_char_min_ms !== null) ? s.ai_in_delay_per_char_min_ms : 18 %>">
              </div>
              <div class="col-md-3"><label class="form-label">PerChar Max</label>
                <input type="number" class="form-control" name="ai_in_delay_per_char_max_ms"
                  value="<%= (s.ai_in_delay_per_char_max_ms !== undefined && s.ai_in_delay_per_char_max_ms !== null) ? s.ai_in_delay_per_char_max_ms : 45 %>">
              </div>

              <div class="col-md-3"><label class="form-label">Cap</label>
                <input type="number" class="form-control" name="ai_in_delay_cap_ms"
                  value="<%= (s.ai_in_delay_cap_ms !== undefined && s.ai_in_delay_cap_ms !== null) ? s.ai_in_delay_cap_ms : 5200 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Jitter Min</label>
                <input type="number" class="form-control" name="ai_in_delay_jitter_min_ms"
                  value="<%= (s.ai_in_delay_jitter_min_ms !== undefined && s.ai_in_delay_jitter_min_ms !== null) ? s.ai_in_delay_jitter_min_ms : 400 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Jitter Max</label>
                <input type="number" class="form-control" name="ai_in_delay_jitter_max_ms"
                  value="<%= (s.ai_in_delay_jitter_max_ms !== undefined && s.ai_in_delay_jitter_max_ms !== null) ? s.ai_in_delay_jitter_max_ms : 1600 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Total Min</label>
                <input type="number" class="form-control" name="ai_in_delay_total_min_ms"
                  value="<%= (s.ai_in_delay_total_min_ms !== undefined && s.ai_in_delay_total_min_ms !== null) ? s.ai_in_delay_total_min_ms : 1600 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Total Max</label>
                <input type="number" class="form-control" name="ai_in_delay_total_max_ms"
                  value="<%= (s.ai_in_delay_total_max_ms !== undefined && s.ai_in_delay_total_max_ms !== null) ? s.ai_in_delay_total_max_ms : 9500 %>">
              </div>

              <div class="col-12">
                <h5 class="mt-3">Outbound</h5>
              </div>

              <div class="col-md-3"><label class="form-label">Base Min</label>
                <input type="number" class="form-control" name="ai_out_delay_base_min_ms"
                  value="<%= (s.ai_out_delay_base_min_ms !== undefined && s.ai_out_delay_base_min_ms !== null) ? s.ai_out_delay_base_min_ms : 450 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Base Max</label>
                <input type="number" class="form-control" name="ai_out_delay_base_max_ms"
                  value="<%= (s.ai_out_delay_base_max_ms !== undefined && s.ai_out_delay_base_max_ms !== null) ? s.ai_out_delay_base_max_ms : 1200 %>">
              </div>
              <div class="col-md-3"><label class="form-label">PerChar Min</label>
                <input type="number" class="form-control" name="ai_out_delay_per_char_min_ms"
                  value="<%= (s.ai_out_delay_per_char_min_ms !== undefined && s.ai_out_delay_per_char_min_ms !== null) ? s.ai_out_delay_per_char_min_ms : 22 %>">
              </div>
              <div class="col-md-3"><label class="form-label">PerChar Max</label>
                <input type="number" class="form-control" name="ai_out_delay_per_char_max_ms"
                  value="<%= (s.ai_out_delay_per_char_max_ms !== undefined && s.ai_out_delay_per_char_max_ms !== null) ? s.ai_out_delay_per_char_max_ms : 55 %>">
              </div>

              <div class="col-md-3"><label class="form-label">Cap</label>
                <input type="number" class="form-control" name="ai_out_delay_cap_ms"
                  value="<%= (s.ai_out_delay_cap_ms !== undefined && s.ai_out_delay_cap_ms !== null) ? s.ai_out_delay_cap_ms : 6500 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Jitter Min</label>
                <input type="number" class="form-control" name="ai_out_delay_jitter_min_ms"
                  value="<%= (s.ai_out_delay_jitter_min_ms !== undefined && s.ai_out_delay_jitter_min_ms !== null) ? s.ai_out_delay_jitter_min_ms : 250 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Jitter Max</label>
                <input type="number" class="form-control" name="ai_out_delay_jitter_max_ms"
                  value="<%= (s.ai_out_delay_jitter_max_ms !== undefined && s.ai_out_delay_jitter_max_ms !== null) ? s.ai_out_delay_jitter_max_ms : 1200 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Total Min</label>
                <input type="number" class="form-control" name="ai_out_delay_total_min_ms"
                  value="<%= (s.ai_out_delay_total_min_ms !== undefined && s.ai_out_delay_total_min_ms !== null) ? s.ai_out_delay_total_min_ms : 900 %>">
              </div>
              <div class="col-md-3"><label class="form-label">Total Max</label>
                <input type="number" class="form-control" name="ai_out_delay_total_max_ms"
                  value="<%= (s.ai_out_delay_total_max_ms !== undefined && s.ai_out_delay_total_max_ms !== null) ? s.ai_out_delay_total_max_ms : 12000 %>">
              </div>

              <div class="col-12 mt-2">
                <button class="btn btn-primary">Salvar</button>
                <a class="btn btn-outline-secondary" href="/logout">Sair</a>
              </div>
            </form>

            <hr class="my-4" />

            <!-- NÚMEROS META -->
            <div id="meta-settings">
              <h3 class="mt-3">Números WhatsApp Cloud (Meta)</h3>

              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th style="min-width: 170px;">Número</th>
                    <th style="min-width: 210px;">Phone Number ID</th>
                    <th>Access Token</th>
                    <th style="min-width: 140px;">Label (opcional)</th>
                    <th class="text-center" style="width: 70px;">Ativo?</th>
                    <th style="width: 160px;"></th>
                  </tr>
                </thead>
                <tbody>
                  <% const metaList=(typeof metaNumbers !=='undefined' && metaNumbers) ? metaNumbers : []; %>

                    <% if (metaList.length) { %>
                      <% metaList.forEach(function(n) { %>
                        <tr>
                          <form method="post" action="/admin/settings/meta/save">
                            <td>
                              <input type="hidden" name="id" value="<%= n.id %>">
                              <input type="text" class="form-control form-control-sm" name="display_phone_number"
                                value="<%= n.display_phone_number || '' %>" placeholder="+55 11 99999-9999">
                            </td>
                            <td>
                              <input type="text" class="form-control form-control-sm" name="phone_number_id"
                                value="<%= n.phone_number_id || '' %>" placeholder="phone_number_id" required>
                            </td>
                            <td>
                              <input type="text" class="form-control form-control-sm" name="access_token"
                                value="<%= n.access_token || '' %>" placeholder="Access Token" required>
                            </td>
                            <td>
                              <input type="text" class="form-control form-control-sm" name="label"
                                value="<%= n.label || '' %>" placeholder="ex.: Conta 1">
                            </td>
                            <td class="text-center">
                              <input class="form-check-input" type="checkbox" name="active" <%=n.active ? 'checked' : ''
                                %> />
                            </td>
                            <td class="text-end">
                              <button type="submit" class="btn btn-sm btn-primary me-1">Salvar</button>
                              <button type="submit" class="btn btn-sm btn-outline-danger"
                                formaction="/admin/settings/meta/delete"
                                onclick="return confirm('Remover este número?');">
                                Remover
                              </button>
                            </td>
                          </form>
                        </tr>
                        <% }); %>
                          <% } else { %>
                            <tr>
                              <td colspan="6" class="text-muted">Nenhum número cadastrado</td>
                            </tr>
                            <% } %>

                              <tr>
                                <form method="post" action="/admin/settings/meta/save">
                                  <td>
                                    <input type="hidden" name="id" value="">
                                    <input type="text" class="form-control form-control-sm" name="display_phone_number"
                                      placeholder="+55 11 99999-9999">
                                  </td>
                                  <td>
                                    <input type="text" class="form-control form-control-sm" name="phone_number_id"
                                      placeholder="phone_number_id" required>
                                  </td>
                                  <td>
                                    <input type="text" class="form-control form-control-sm" name="access_token"
                                      placeholder="Access Token" required>
                                  </td>
                                  <td>
                                    <input type="text" class="form-control form-control-sm" name="label"
                                      placeholder="ex.: Conta 2">
                                  </td>
                                  <td class="text-center">
                                    <input class="form-check-input" type="checkbox" name="active" checked />
                                  </td>
                                  <td class="text-end">
                                    <button type="submit" class="btn btn-sm btn-success">Adicionar</button>
                                  </td>
                                </form>
                              </tr>
                </tbody>
              </table>
            </div>

            <script>
              // ==== Provider UI toggle (AI + VoiceNote + Pagamentos) ====
              (function () {
                function toKey(v, fallback) {
                  const s = (v == null ? '' : String(v)).trim().toLowerCase();
                  return s || (fallback || '');
                }

                // Deixa a UI 100% extensível:
                // - AI: crie containers com id="ai_provider_<provider>"
                // - VoiceNote: crie containers com id="vn_provider_<provider>"
                // - Pagamentos: crie containers com id="pay_gateway_<gateway>"
                // O JS ativa automaticamente o container correspondente ao value do <select>.
                function toggleGroupByPrefix(prefix, activeKey) {
                  const nodes = document.querySelectorAll(`[id^="${prefix}"]`);
                  nodes.forEach((el) => {
                    const key = toKey(el.id.slice(prefix.length));
                    el.classList.toggle('active', key === activeKey);
                  });
                }

                function updateAIProviderUI() {
                  const sel = document.getElementById('ai_provider');
                  const provider = toKey(sel && sel.value, 'venice');
                  toggleGroupByPrefix('ai_provider_', provider);
                }

                function updateVoiceNoteUI() {
                  const vnSel = document.getElementById('voice_note_ai_provider');
                  const mainSel = document.getElementById('ai_provider');

                  const vn = toKey(vnSel && vnSel.value, 'inherit');
                  const provider =
                    vn === 'inherit'
                      ? toKey(mainSel && mainSel.value, 'venice')
                      : vn;

                  toggleGroupByPrefix('vn_provider_', provider);
                }

                function updatePayGatewayUI() {
                  const sel = document.getElementById('pix_gateway_default');
                  const gw = toKey(sel && sel.value, 'veltrax');
                  toggleGroupByPrefix('pay_gateway_', gw);
                }

                function bind() {
                  const aiSel = document.getElementById('ai_provider');
                  if (aiSel) aiSel.addEventListener('change', updateAIProviderUI);

                  const vnSel = document.getElementById('voice_note_ai_provider');
                  if (vnSel) vnSel.addEventListener('change', updateVoiceNoteUI);
                  if (aiSel) aiSel.addEventListener('change', updateVoiceNoteUI);

                  const paySel = document.getElementById('pix_gateway_default');
                  if (paySel) paySel.addEventListener('change', updatePayGatewayUI);

                  updateAIProviderUI();
                  updateVoiceNoteUI();
                  updatePayGatewayUI();
                }

                if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', bind);
                } else {
                  bind();
                }
              })();

              // ==== Máscara número Meta ====
              function formatNumero(value) {
                let v = (value || '').replace(/\D/g, '');
                v = v.slice(0, 13);
                if (!v) return '';

                let out = '+';
                if (v.length <= 2) { out += v; return out; }

                out += v.slice(0, 2) + ' ';
                if (v.length <= 4) { out += v.slice(2); return out; }

                out += v.slice(2, 4) + ' ';
                if (v.length <= 9) { out += v.slice(4); return out; }

                out += v.slice(4, 9) + '-' + v.slice(9);
                return out;
              }

              function attachNumeroMasks() {
                const inputs = document.querySelectorAll('input[name="display_phone_number"]');
                inputs.forEach((inp) => {
                  inp.addEventListener('input', (e) => {
                    const cursorPos = e.target.selectionStart;
                    const oldLength = e.target.value.length;

                    const formatted = formatNumero(e.target.value);
                    e.target.value = formatted;

                    const newLength = formatted.length;
                    const diff = newLength - oldLength;
                    const newPos = Math.max(0, (cursorPos || 0) + diff);
                    try { e.target.setSelectionRange(newPos, newPos); } catch { }
                  });
                });
              }

              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', attachNumeroMasks);
              } else {
                attachNumeroMasks();
              }
            </script>
</body>

</html>